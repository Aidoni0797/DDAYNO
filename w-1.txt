Wireshark - руководство по  анализу трафика сети
1. Что такое Wireshark?
Wireshark - это широко распространённый инстрмент для захвата и анализа сетевого трафика, который активно 
используется как для образовательных целей, так и для устранения неполадок на компьютере или в сети.
Wireshark работает практически со всеми протоколами модели OSI, обладает понятным для обычного пользователя
интерфейсом и удобной системой фильтрации данных. Помимо всего этого, программа является кроссплатформенной
и поддерживает следующие операционные системы: Windows, Linux, Mac OS X, Solaris, FreBSD, NetBSD, OpenBSD.
В этом руководстве мы рассмотрим основной функционал программы Wireshark, соотнесём её с моделью OSI,  
научимся анализировать сетевой трафик и обезопасим своё  нахождение в глобальой сети Интернет.

2. Как установить Wireshark?
Для начала нам еобходимо скачать и установить программу Wireshark. Так как программа распространяется под
лицензией GNU GPL v2 (т.е. может свободно распространяться), то несложно найти любую версию программы
в свободном доступе. В руководстве мы будем использовать функционал более ранней версий программы. Это вызвано
тем, что в этой версии сразу встроен протокол SSL, который используется в главе 6. Установка более ранней
версии облегчает подготовку к работе с программой, поэтому мы выбрали её. Найти установщик можно на 
официальном сайте.
Дальнейшая установка программы проста - нажимает Next - Next - Next.
После успешной установки на Вашем рабочем столе появится ярлык Wireshark. Мы можем приступать к рассмотрению
функционала!

3. Как пользоваться программой Wireshark?
Одна из главных возможностей программы - это захват графика сети. Поэтому для начала необходимо научиться захватывать
трафик Вашей сети.
Запустим программу! Нас сразу встречает стратовое меню, на котором можно увидеть доступные для захвата
интерфейсы компьютера, руководства от разработчиков программы и множество других интересных вещей.
Из всего этого нам необходимо обратить внимание на эту область программы.
Здесь нужно выбрать тот сетевой интерфейс, через который Вы подключены к Интернету.
Сетевой интерфейс - это программное обеспечение, которое взаимодействует с сетевым драйвером и с уровнем IP.
Он обеспечивает уровню IP доступ ко всем имеющимся сетевым адаптерам, трафик которых мы будем перехватывать.
Чаще всего в программе Wireshark можно встретить сетевой интерфейс беспроводной (Wi-Fi) и кабельный (Ethernet).
В руководстве используется Wi-Fi, поэтому мы выполняем захват Беспроводной сети, после чего нажимаем Start.
Если вы выбрали правильный интерфейс, то сможете увидеть следующее.
Рассмотрим подробнее это окно по пунктам, указанным на нём:
1. Панель фильтров, позволяющая найти необходимую информацию. Подробнее о неё рассказано в пятой главе руководства.
2. Панель наименований, разделяющая информацию из пункта 3 на номер, временя с начала захвата трафика,
источник и адресат, а также используемый протокол, размер пакета и небольшую информацию о сетевом пакете.
3. Панель пакетов, обновляющаяся в реальном времени. Здесь информация о пакетах разделена по столбцам,
определённым на панели наименований.
4. Панель уровней, описывающая уровни модели OSI выбранного сетевого пакета.
5. Панель метаданных, представляющая данные в шестнадцатеричном коде и символах.
Поздравляем! Вы успешно захватли трафик Вашей сети. Теперь можно увидеть пакеты данных, происходящих по
сети, а также некоторую информацию о них: адреса отправителя и получателя, использующиеся протоколы и содержание
пакета.
Теперь можно приступить к анализу сетевого трафика.

4. Как найти скрытую информацию?
Перед началом анализа трафика необходимо иметь базовые знания о протоколах сетевой модели OSI. Достаточно
прочитать статью в Википедии.
Во многих программах для передачи информации используется протокол HTTP, который позволяет получать различные
ресурсы из Интернета и обратно. РАссмотрим один из пакетов, переданных по протоколу HTTP.

В протоколе HTTP для передачи данных используется запросы GET (предназначен для получения данных) и
POST (предназначен для отправки данных).

На рисунке в поле 1 мы видим IP-адрес адресата (в данном случае, это адрес моего компьютера). В поле 2 мы узнаём,
что сервер антивируса послал запрос GET для того, чтобы запросить некоторые данные о моём компьютере.
Это необходимо для корректного обновления программы. И в полле 3 мы видим то, как выглядит этот запрос в виде
URL (Интернет-ссылки).

Небольшое домашнее задание!
Для закрепления материала попробуйте проанализировать любой пакет протокола HTTP на вашем компьютере и 
попытайтесь объяснить, для чего он был отправлен.

5. Как среди всех пакетов найти необходимые?
При выполнении домашнего задания у Вас могла возникнуть проблема нахождения необходимого пакета. Для её решения
в программе Wireshark есть решение - фильтрация! В специальном поле Filter можно ввести необходимые команды
или воспользоваться подсказками.

Чаще всего используется фильтрация по IP-адресам, по номерам порта и по протоколам. Давайте посмотрим, как это
происходит.

Фильтрация по IP-адресу позволяет нам просматривать все пакеты, приходящие от кого-либо или уходящие кому-либо.
Например, отберём все пакеты, приходящие от IP-адреса 10.1.30.46 с помощью ввода в фильтре "ip.src=x.x.x.x".

Также можно отфильтровать трафик сети по IP-адресу получателя пакетов с помощью комады "ip.dt == x.x.x.x".

Кроме того, можно увидеть пакеты вне зависимости от направления трафика с помощью "ip.addr == x.x.x.x".

Для фильтрации по номеру порта используется ".port = x" после названия протокола.

Например, для просмотра ТСР-порта 80, используемого для незашифрованного трафика HTTP, используем команду
"tcp.port == 80".

И наконец, для фильтрации трафика по используемым пакетами протоколам необходимо просто ввести название протокола.

Обратите внимание, что фильтры можно комбинировать при помощи логических операторов И "and/&&", ИЛИ "or/||"
и НЕ "not/!".

Снова домашнее задание!
Чтобы попрактиковаться в поиске необходимой информации, попрообуйте посмотреть количество пакетов того или
иного протокола и подумайте, почему их так много.

6. Как перехватить данные, передающиеся по защищённым каналам связи?
Разобравшись с основным функционалом Wireshark, мы можем приступить к более сложному и полезному.

Передача данных в глобальной сети Интернет является небезопасной, особенно если никак не защищать их.
В современных браузерах используется протокол SSL/TSL, который шифрует информацию и позволяет безопасно передать
её.

Иногда пользователю или системного администратору необходимо проверить трафик на наличие подозрительной
активности или на корректную работу программы. Из-за этого возникает необходимость расшифровывать 
перехваченный защищённый трафик.

Для начала разберёмся в том, как работает протокол SSL/TLS. Перед обменом шифрованными данными используется 
процесс установки соединения, также называемый рукопожатием.

На этапе рукопожотия клиент и сервер проходят аутентификацию (проверку подлинности), обмениюватся
информацией о своих возможностях и лишь после этого начинают соглосование общего сеансового ключа.

Для соглосования по незащищённому каналу связи существует множество алгоритмов. Выбор происходит из списка
алгоритмов, которые поддержваются клиентом, на начальной стадии рукопожатия.

Наиболее распространённым алгоритмом обмена сеансовым ключом является RSA. Рассмотрим инфорграфику, 
описывающую механизм работы алгоритма.

В момент рукопожатия клиент создаёт случайное число, называемое предварительным секретом, и отправляют его,
зашифровав открытым ключом сервера. Далее обе стороны конвертируют предварительный секрет в главный и создают
сеансовый ключ, который и используется для дальнейшего обмена информацией.

Теперь попробуем прехватить защищённую информацию в программе Wireshark. Выполним подготовительные действия,
а именно проверим используемый для соглосования сеансовых ключей алгоритм и настроим браузер. Для начала находим
рукопожатие с помощью фильтра, введя "ssl.handshake", и проверяем сообщение сервера.

В поле Cipher Suite мы можем увитель TLS_RSA. Это значит, что мы можем приступать к дальнейшим действиям.

Настройка браузера в операционной система Windows довольна проста. Открываем свойства компьютера, затем
"Дополнительные параметры системы" и выбираем "Переменные среды...".

Добавляем новую пользовательскую переменную "SSKEYLOGFILE" и указываем путь до файла, куда мы ходим его
сохранять.

Рассмотрим ответное сообщение клиента: оно содержит зашифрованное значение предварительного секрета текущей сессии.

Далее переходим к настройке программы Wireshark. Комбинауцией Ctrl+Shift+P открываем меню "Preferences",
затем раскрываем ветку "Protocols" и выбираем SSL.

Проверяем установку необходимых полей, показанных на картинке, и жмём кнопку "Edit". В появившемся окне
нажимаем на кнопку New и заполняем следующие поля: IP Address (IP-адрес SSL-сервера), Port
(порт SSL-сервера), Protocol (протокол, использующий шифрацию SSL. При неизвестном указывать data),
Key File (путь к файлу с секретным ключом сервера, который мы указывали в Переменных средах) и Password
(если секретный ключ защищён паролем).

Теперь можноподтвердить настройки и приступить к просмотру расшифрованного трафика. Не забывайте использовать фильтр!

Закрепление пройденного материала!

Попробуйте самостоятельно подключиться к серверу какого-либо сайта и посмотреть, какими пакетами обменивается 
Вам компьютер с ним.

7. Какие возможности даёт захват защищённого трафика?
Захват защищённого трафика даёт множество возможностей. Одной из них является перехват HTTPS-запросов пользователей,
подключённых к сети. Давайте рассмотрим, как это сдлетьа и какой результат мы получим.

Для начала повторяем действия из предыдущего пункта, но в качестве IP-адреса SSL-сервера указываем адрес
необходимого сайта. Для передачи паролей зачастую используется протокол передачи данных HTTP.
О используемых в нём методах мы уже говорили в главе 4. Чтобы использовать фильтрацию HTTP-трафика
по методам, можно использовать команду "http.request.method == "название метода"". Так как мы хотим
перехватить данные, отправленные клиентом на сервер, то будем рассматривать POST-запросы. Эля этого применим
фильтр "http.request.method == "POST""

Проделав эти несложные действия, мы получили важные данные другого пользователя. Поэтому следует помнить, что 
общедоступные сети являются небезопасными и представляют угрозу даже защищённого трафика.

Небольшая практика!
Попробуйте захватить защищённый трафик сервера электронной почты и авторизуйтесь, используя логин и пароль. 
Найдите POST-запрос и посмотрите, что там находится.

Скорее всего, важные данные будут зашифрованы. Таким способом почтовый сервис защищает Ваши данные, но риск
взлома всё равно остаётся.

8. Как можно соотнести модель OSI и программу Wireshark?

Рассмотрев весь функционал программы Wireshark, мы можем соотнести её с сетевой моделью OSI. Но для начала 
следует вспомнить, что из себя представляет эта модель.

OSI - это набор сетевых протоколов, посредством которого различные сетевые устройства взаимодейтсвуют 
друг с другом. Модель определяет семь уровней взаимодействия систем. Рассмотрим уровней модели OSI.

7. Прикладной - данные - доступ к сетеым службам - HTTP, FTP
6. Представления - данные - представление и шифрование данных - ASCII, JPEG
5. Сеансовый - данные - управление сеансом связи - RPC, PAP
4. Транспортный - сегменты - прямая связь между конечными пунктами и надёжность - TCP, UDP
3. Сетевой - пакеты - опредеение маршрута и логическая адресация - IPv4, IPv6, ICMP
2. Канальный - кадры - физическая адресация - Ethernet, ARP
1. Физический - биты - работа со средой передачи, сигналами и двоичными данными - USB, RJ

Теперь соотнесём эти уровни с Wireshark. Рассмотрим наиболее часто встречающиеся при анализе трафика протоколы,
а именно HTTP, TCP, ICMP.

Протокол HTTP в программе Wireshark имеет 4 уровня по модели OSI, а именно прикладной 
(Hypertext Transfer Protocol), Транспортный (ТСР), сетевой (IPv4) и канальный (Ethernet II).

Протокол ТСР имеет 3 уровня по модели OSI, в которые входят транспортный (ТСР), сетевой (IPv4) 
и канальный (Ethernet II).

Протокол ICMP вообще имеет лишь 2 уровня по модели OSI: сетевой (IPv4) и канальный (Ethernet II).

Всего в программе Wireshark определяется лишь 5 уровней модели OSI: прикладной, транспортный, сетевой,
канальный и физический. В зависимости от протокола можно увидеть разные уровни.

Поведение итогов:
Прочитав это руководство, мы научились анализировать трафик и искать скрытую информацию, а также 
перехватывать защищённую информцию. Для будущих специалистов по информационной безопасности это очень важные
навыки, которые обязательно прогодятся в будущем и послужат фундаментом для будущего профессионального развития.
